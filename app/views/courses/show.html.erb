<% content_for :title, @course.name %>

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <!-- Course Header -->
  <div class="bg-gradient-to-br <%= course_gradient_class(@course) %> text-white">
    <div class="container-xl py-12">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
        <!-- Course Info -->
        <div class="lg:col-span-2">
          <%= link_to courses_path, class: "btn-ghost btn-sm text-white/80 hover:text-white mb-4 inline-flex" do %>
            <%= lucide_icon "arrow-left", class: "w-4 h-4 mr-2" %>
            返回课程列表
          <% end %>
          
          <h1 class="text-4xl font-bold mb-4"><%= @course.name %></h1>
          <p class="text-xl text-white/90 mb-6"><%= @course.description %></p>
          
          <div class="flex flex-wrap gap-4">
            <div class="flex items-center gap-2">
              <%= lucide_icon "book-open", class: "w-5 h-5" %>
              <span><%= @course.lessons.count %> 个课时</span>
            </div>
            <div class="flex items-center gap-2">
              <%= lucide_icon "layers", class: "w-5 h-5" %>
              <span><%= @course.chapters.count %> 个章节</span>
            </div>
            <div class="flex items-center gap-2">
              <%= lucide_icon "users", class: "w-5 h-5" %>
              <span><%= @course.users.count %> 位学员</span>
            </div>
          </div>
        </div>

        <!-- Subscribe Card -->
        <div class="card bg-white/10 backdrop-blur-lg border border-white/20">
          <div class="card-body">
            <% if current_user && @subscription && @subscription.active? %>
              <!-- Already Subscribed -->
              <div class="text-center mb-4">
                <%= lucide_icon "check-circle", class: "w-16 h-16 mx-auto mb-3 text-green-400" %>
                <h3 class="text-xl font-bold mb-2">已订阅</h3>
                <% if @subscription.payment_type == 'buyout' %>
                  <p class="text-white/80 text-sm">买断模式 - 永久有效</p>
                <% else %>
                  <p class="text-white/80 text-sm">
                    有效期至<br/>
                    <%= @subscription.expires_at.strftime('%Y年%m月%d日') %>
                  </p>
                <% end %>
              </div>
              
              <%= link_to "继续学习", @first_lesson || @course.lessons.first, class: "btn-primary w-full mb-2" %>
              <%= link_to "查看进度", dashboard_progresses_path, class: "btn-ghost text-white/80 hover:text-white w-full" %>
            <% else %>
              <!-- Subscribe Options -->
              <h3 class="text-xl font-bold mb-4 text-center">开始学习</h3>
              
              <% if @course.buyout? %>
                <!-- Buyout Only -->
                <div class="mb-4 p-4 bg-white/10 rounded-lg text-center">
                  <div class="text-3xl font-bold mb-1">¥<%= sprintf('%.2f', @course.buyout_price) %></div>
                  <div class="text-sm text-white/70">买断制 - 永久访问</div>
                </div>
                <% if current_user %>
                  <%= link_to "立即购买", new_subscription_path(course_id: @course.id, payment_type: 'buyout'), class: "btn-primary w-full" %>
                <% else %>
                  <%= link_to "登录后购买", sign_in_path, class: "btn-primary w-full" %>
                <% end %>
              <% else %>
                <!-- Annual Subscription -->
                <div class="mb-4 p-4 bg-white/10 rounded-lg text-center">
                  <div class="text-3xl font-bold mb-1">¥<%= sprintf('%.2f', @course.annual_price) %></div>
                  <div class="text-sm text-white/70">年订阅 - 365天访问权限</div>
                  <div class="text-xs text-white/60 mt-2">续费时顺延叠加</div>
                </div>
                <% if current_user %>
                  <%= link_to "立即订阅", new_subscription_path(course_id: @course.id, payment_type: 'annual'), class: "btn-primary w-full" %>
                <% else %>
                  <%= link_to "登录后订阅", sign_in_path, class: "btn-primary w-full" %>
                <% end %>
              <% end %>
              
              <div class="mt-4 text-center text-xs text-white/60">
                <%= lucide_icon "shield-check", class: "w-3 h-3 inline" %>
                安全支付 | 7天无理由退款
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Course Content -->
  <div class="container-xl py-12">
    <% if @course.chapters.any? %>
      <div class="space-y-4">
        <% @course.chapters.each_with_index do |chapter, index| %>
          <div class="card">
            <div class="card-header bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50">
                  <%= "第#{index + 1}章" %> <%= chapter.name %>
                </h2>
                <span class="text-sm text-gray-600 dark:text-gray-400">
                  <%= chapter.lessons.count %> 个课时
                </span>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="divide-y divide-gray-200 dark:divide-gray-700">
                <% chapter.lessons.each_with_index do |lesson, lesson_index| %>
                  <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-4 flex-1">
                        <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-sm font-medium text-gray-600 dark:text-gray-400">
                          <%= lesson_index + 1 %>
                        </div>
                        
                        <div class="flex-1">
                          <%= link_to lesson.name, lesson_path(lesson), class: "text-gray-900 dark:text-gray-50 hover:text-primary font-medium" %>
                          <% if lesson.video_url.present? %>
                            <span class="ml-2 inline-flex items-center gap-1 text-xs text-gray-500">
                              <%= lucide_icon "video", class: "w-3 h-3" %>
                              视频
                            </span>
                          <% end %>
                        </div>
                      </div>
                      
                      <div class="flex items-center gap-3">
                        <% if lesson.free? %>
                          <span class="badge badge-success">试看</span>
                        <% elsif current_user && current_user.has_access_to?(@course) %>
                          <% progress = current_user.progresses.find_by(lesson: lesson) %>
                          <% if progress&.status == 'completed' %>
                            <%= lucide_icon "check-circle", class: "w-5 h-5 text-green-500" %>
                          <% end %>
                        <% else %>
                          <%= lucide_icon "lock", class: "w-5 h-5 text-gray-400" %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="card">
        <div class="card-body text-center py-12">
          <%= lucide_icon "book-open", class: "w-16 h-16 mx-auto mb-4 text-gray-400" %>
          <p class="text-gray-600 dark:text-gray-400">课程内容正在准备中...</p>
        </div>
      </div>
    <% end %>
  </div>
</div>
