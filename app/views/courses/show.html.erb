<% content_for :title, @course.name %>

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <!-- Course Header -->
  <div class="bg-gradient-to-br <%= course_gradient_class(@course) %> text-white">
    <div class="container-xl py-12">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
        <!-- Course Info -->
        <div class="lg:col-span-2">
          <%= link_to courses_path, class: "btn-ghost btn-sm text-white/80 hover:text-white mb-4 inline-flex" do %>
            <%= lucide_icon "arrow-left", class: "w-4 h-4 mr-2" %>
            返回课程列表
          <% end %>
          
          <h1 class="text-4xl font-bold mb-4"><%= @course.name %></h1>
          <p class="text-xl text-white/90 mb-6"><%= @course.description %></p>
          
          <!-- 课程工具 -->
          <% if course_tool(@course).present? %>
            <% tool = course_tool(@course) %>
            <div class="flex items-center gap-2 mb-6">
              <span class="font-semibold text-white">工具：</span>
              <span class="font-bold text-white text-lg"><%= tool[:name] %></span>
              <% if tool[:self_developed] %>
                <span class="badge badge-warning text-xs">自研</span>
              <% end %>
            </div>
          <% end %>
          
          <div class="flex flex-wrap gap-4">
            <div class="flex items-center gap-2">
              <%= lucide_icon "book-open", class: "w-5 h-5" %>
              <span><%= @course.lessons.count %> 个课时</span>
            </div>
            <div class="flex items-center gap-2">
              <%= lucide_icon "layers", class: "w-5 h-5" %>
              <span><%= @course.chapters.count %> 个章节</span>
            </div>
            <div class="flex items-center gap-2">
              <%= lucide_icon "users", class: "w-5 h-5" %>
              <span><%= @course.users.count %> 位学员</span>
            </div>
          </div>
        </div>

        <!-- Subscribe Card -->
        <div class="card bg-white/10 backdrop-blur-lg border border-white/20">
          <div class="card-body">
            <% if current_user && @subscription && @subscription.active? %>
              <!-- Already Subscribed -->
              <div class="text-center mb-4">
                <%= lucide_icon "check-circle", class: "w-16 h-16 mx-auto mb-3 text-green-400" %>
                <h3 class="text-xl font-bold mb-2">已报名</h3>
                <p class="text-white/80 text-sm">
                  课程内容永久查阅<br/>
                  <% if @subscription.offline_eligible? %>
                    <% offline_eligible_until = @subscription.started_at + 1.year %>
                    线下面授资格至 <%= offline_eligible_until.strftime('%Y年%m月%d日') %>
                  <% elsif !@course.free? %>
                    线下预约资格已过期
                  <% end %>
                </p>
              </div>
              
              <%= link_to "继续学习", @first_lesson || @course.lessons.first, class: "btn-primary w-full mb-2" %>
              <%= link_to "查看进度", dashboard_progresses_path, class: "btn-ghost text-white/80 hover:text-white w-full" %>
            <% else %>
              <!-- Subscribe Options -->
              <h3 class="text-xl font-bold mb-4 text-center">开始学习</h3>
              
              <div class="mb-4 p-4 bg-white/10 rounded-lg">
                <% if @course.free? %>
                  <!-- 免费课程 -->
                  <div class="text-center mb-2">
                    <span class="text-sm text-white/60 line-through">原价 ¥<%= sprintf('%.0f', @course.original_price) %></span>
                  </div>
                  <div class="text-3xl font-bold mb-3 text-center text-white">免费</div>
                  <div class="text-sm text-white/90 space-y-1">
                    <div class="flex items-center gap-2">
                      <%= lucide_icon "infinity", class: "w-4 h-4" %>
                      <span>课程内容永久查阅</span>
                    </div>
                  </div>
                <% else %>
                  <!-- 付费课程 - 三档价格 -->
                  <% if @course.original_price.present? && @course.early_bird_price.present? %>
                    <!-- 三档价格显示 -->
                    <div class="space-y-3">
                      <!-- 原价 -->
                      <div class="text-center">
                        <div class="text-sm text-white/60">原价</div>
                        <div class="text-lg text-white/60 line-through">¥<%= sprintf('%.0f', @course.original_price) %></div>
                      </div>
                      
                      <!-- 现价 -->
                      <% if @course.current_price.present? %>
                        <div class="text-center">
                          <div class="text-sm text-white/80">现价</div>
                          <div class="text-2xl font-bold text-white">¥<%= sprintf('%.0f', @course.current_price) %></div>
                        </div>
                      <% end %>
                      
                      <!-- 早鸟价（最突出） -->
                      <div class="text-center border-t border-white/20 pt-3">
                        <div class="flex items-center justify-center gap-2 mb-1">
                          <%= lucide_icon "zap", class: "w-4 h-4 text-yellow-300" %>
                          <span class="text-sm font-semibold <%= course_price_color(@course) %>">早鸟特惠</span>
                        </div>
                        <div class="text-4xl font-bold <%= course_price_color(@course) %>">¥<%= sprintf('%.0f', @course.early_bird_price) %></div>
                        <div class="text-xs text-white/60 mt-1">限时优惠</div>
                      </div>
                    </div>

                  <% else %>
                    <!-- 单一价格显示 -->
                    <div class="text-3xl font-bold mb-2 text-center">¥<%= sprintf('%.2f', @course.annual_price) %></div>
                  <% end %>
                  
                  <div class="text-sm text-white/90 space-y-1 mt-4">
                    <div class="flex items-center gap-2">
                      <%= lucide_icon "infinity", class: "w-4 h-4" %>
                      <span>课程内容永久查阅</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <%= lucide_icon "calendar", class: "w-4 h-4" %>
                      <%= link_to "一年内可预约线下面授", offline_bookings_path, class: "hover:underline" %>
                    </div>
                  </div>
                <% end %>
              </div>
              <% if current_user %>
                <% if @course.free? %>
                  <%= link_to "免费报名", subscriptions_path(course_id: @course.id), method: :post, class: "btn-primary w-full" %>
                <% else %>
                  <%= link_to "立即购买", new_subscription_path(course_id: @course.id), class: "btn-primary w-full" %>
                <% end %>
              <% else %>
                <% if @course.free? %>
                  <%= link_to "登录后报名", sign_in_path, class: "btn-primary w-full" %>
                <% else %>
                  <%= link_to "登录后购买", sign_in_path, class: "btn-primary w-full" %>
                <% end %>
              <% end %>
              
              <% unless @course.free? %>
                <div class="mt-4 text-center text-xs text-white/60">
                  <%= lucide_icon "shield-check", class: "w-3 h-3 inline" %>
                  安全支付
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Course Content -->
  <div class="container-xl py-12">
    <% if @course.chapters.any? %>
      <div class="space-y-4">
        <% @course.chapters.each_with_index do |chapter, index| %>
          <div class="card">
            <div class="card-header bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50">
                  <%= "第#{index + 1}章" %> <%= chapter.name %>
                </h2>
                <span class="text-sm text-gray-600 dark:text-gray-400">
                  <%= chapter.lessons.count %> 个课时
                </span>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="divide-y divide-gray-200 dark:divide-gray-700">
                <% chapter.lessons.each_with_index do |lesson, lesson_index| %>
                  <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-4 flex-1">
                        <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-sm font-medium text-gray-600 dark:text-gray-400">
                          <%= lesson_index + 1 %>
                        </div>
                        
                        <div class="flex-1">
                          <%= link_to lesson.name, lesson_path(lesson), class: "text-gray-900 dark:text-gray-50 hover:text-primary font-medium" %>
                          <% if lesson.video_url.present? %>
                            <span class="ml-2 inline-flex items-center gap-1 text-xs text-gray-500">
                              <%= lucide_icon "video", class: "w-3 h-3" %>
                              视频
                            </span>
                          <% end %>
                        </div>
                      </div>
                      
                      <div class="flex items-center gap-3">
                        <% if lesson.free? %>
                          <span class="badge badge-success">试看</span>
                        <% elsif current_user && current_user.has_access_to?(@course) %>
                          <% progress = current_user.progresses.find_by(lesson: lesson) %>
                          <% if progress&.status == 'completed' %>
                            <%= lucide_icon "check-circle", class: "w-5 h-5 text-green-500" %>
                          <% end %>
                        <% else %>
                          <%= lucide_icon "lock", class: "w-5 h-5 text-gray-400" %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="card">
        <div class="card-body text-center py-12">
          <%= lucide_icon "book-open", class: "w-16 h-16 mx-auto mb-4 text-gray-400" %>
          <p class="text-gray-600 dark:text-gray-400">课程内容正在准备中...</p>
        </div>
      </div>
    <% end %>
  </div>
</div>
